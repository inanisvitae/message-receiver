"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(exports,"__esModule",{value:!0});var _intercomClient=require("intercom-client"),_config=require("config"),_config2=_interopRequireDefault(_config),_pg=require("pg"),_pg2=_interopRequireDefault(_pg),_bunyan=require("bunyan"),_bunyan2=_interopRequireDefault(_bunyan),_publicConst=require("./publicConst");const log=_bunyan2.default.createLogger({name:"customerSyncGuestOrder"}),client=new _intercomClient.Client(_config2.default.get("thirdPartyPlatform.intercom")),connPool=new _pg2.default.Pool(_config2.default.get("database.pg")),customAttributesReducer=t=>{client.users.find({user_id:t}).then(()=>{const e={num_orders:0,total_payment:0,category_slug_string:"",project_slug_string:"",status_num_pending:0,status_num_pending_deleted:0,status_num_paid:0,status_num_waiting_for_delivery:0,status_num_waiting_for_delivery_unpaid:0,status_num_delivered:0,status_num_waiting_for_pickup:0,status_num_waiting_for_pickup_unpaid:0,status_num_completed:0,status_num_closed:0,status_num_refund_pending:0,status_num_refunded:0,status_num_refund_failed:0,promoter_username_string:""},r=`SELECT t1.customer_id AS customer_id, t1.guest_id AS guest_id, t1.status AS status, t1.deleted_at AS deleted_at, t2.username AS promoter_username_string, t1.id AS id, t1.payment AS payment, t3.project_id AS project_id, t3.project_slug AS project_slug, t5.slug AS category_slug FROM(SELECT customer_id, guest_id, status, deleted_at, promoter_id, payment, id FROM public.order WHERE customer_id = ${Number.parseInt(t,10)}) t1, (SELECT username, id FROM public.promoter) t2, (SELECT project_slug, order_id, id, project_id FROM public.order_detail) t3, (SELECT project_id, category_id FROM public.project_to_category) t4, (SELECT slug, id FROM public.category) t5 WHERE t1.promoter_id = t2.id AND t3.order_id = t1.id AND t4.project_id = t3.project_id AND t3.category_id = t5.id; `;connPool.query(r,[],(r,u)=>{if(!r&&u){const r=u.rows;if(r.length<=0)return;let s=0,_=0;r.forEach(t=>{const r=`status_num_${t.status}`;-1!==_publicConst.completedOrdersSignature.indexOf(t.status)&&(s+=1),e[r]=Number.parseInt(e[r],10),e[r]+=1,_+=Number.parseInt(t.payment,10),e.project_slug_string.includes(t.project_slug)||(""===e.project_slug_string?e.project_slug_string=`,${t.project_slug},`:e.project_slug_string+=`${t.project_slug},`),e.category_slug_string.includes(t.category_slug)||(""===e.category_slug_string?e.category_slug_string=`,${t.category_slug},`:e.category_slug_string+=`${t.category_slug},`),e.promoter_username_string.includes(t.username)||(""===e.promoter_username_string?e.promoter_username_string=`,${t.username},`:e.promoter_username_string+=`${t.username},`)}),e.total_payment=_,e.num_orders=s,client.users.update({user_id:t,custom_attributes:e}).catch(t=>{log.info(t)})}})}).catch(t=>{log.info(t)})},syncGuestOrders=t=>{t.assertQueue("CUSTOMER:SYNC_GUEST_ORDERS",{durable:!0}),t.consume("CUSTOMER:SYNC_GUEST_ORDERS",t=>{const e=JSON.parse(t.content).customer_id;customAttributesReducer(e)},{noAck:!0})};exports.default=(t=>{t.assertQueue("CUSTOMER:SYNC_GUEST_ORDERS",{durable:!0}),t.consume("CUSTOMER:SYNC_GUEST_ORDERS",t=>{const e=JSON.parse(t.content).customer_id;customAttributesReducer(e)},{noAck:!0})});