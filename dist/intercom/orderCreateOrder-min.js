"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(exports,"__esModule",{value:!0});var _intercomClient=require("intercom-client"),_config=require("config"),_config2=_interopRequireDefault(_config),_pg=require("pg"),_pg2=_interopRequireDefault(_pg),_bunyan=require("bunyan"),_bunyan2=_interopRequireDefault(_bunyan);const log=_bunyan2.default.createLogger({name:"orderCreateOrder"}),client=new _intercomClient.Client(_config2.default.get("thirdPartyPlatform.intercom")),connPool=new _pg2.default.Pool(_config2.default.get("database.pg")),createOrder=t=>{t.assertQueue("ORDER:CREATE_ORDER",{durable:!0}),t.consume("ORDER:CREATE_ORDER",t=>{const e=JSON.parse(t.content),r=e.customer_id,s=e.email,o=e.project_slug,u=e.project_id,_=e.promoter_id,n=`SELECT t2.id, t2.slug AS category_slug FROM (SELECT category_id FROM public.project_to_category WHERE project_id = '${Number.parseInt(u,10)}') t1, public.category t2 WHERE t1.category_id = t2.id;`,i=`SELECT username, id FROM public.promoter WHERE id = '${_}';`;connPool.query(n,[],(t,e)=>{if(t)log.info(t);else if(e.rows.length>0){const t=e.rows[0].category_slug;r?client.users.find({user_id:r}).then(e=>{const s={user_id:r,custom_attributes:{project_slug_string:"",category_slug_string:"",promoter_username_string:""}},u=e.body.custom_attributes;u.project_slug_string?u.project_slug_string.includes(o)||(s.custom_attributes.project_slug_string=`${u.project_slug_string+o},`):s.custom_attributes.project_slug_string=`,${o},`,u.category_slug_string?u.category_slug_string.includes(t)||(s.custom_attributes.category_slug_string=`${u.category_slug_string+t},`):s.custom_attributes.category_slug_string=`,${t},`,connPool.query(i,[],(t,e)=>{if(t)log.info(t);else if(e.rows.length>0){const t=e.rows[0].username;u.promoter_username_string?u.promoter_username_string.includes(t)||(s.custom_attributes.promoter_username_string=`${u.promoter_username_string+t},`):s.custom_attributes.promoter_username_string=`,${t},`}client.users.update(s).catch(t=>{log.info(t)})})}).catch(t=>{log.info(t)}):client.users.find({email:s}).then(e=>{const s={user_id:r,custom_attributes:{project_slug_string:"",category_slug_string:"",promoter_username_string:""}},u=e.body.custom_attributes;u.project_slug_string?u.project_slug_string.includes(o)||(s.custom_attributes.project_slug_string=`${u.project_slug_string+o},`):s.custom_attributes.project_slug_string=`,${o},`,u.category_slug_string?u.category_slug_string.includes(t)||(s.custom_attributes.category_slug_string=`${u.category_slug_string+t},`):s.custom_attributes.category_slug_string=`,${t},`,connPool.query(i,[],(t,e)=>{if(t)log.info(t);else if(e.rows.length>0){const t=e.rows[0].username;u.promoter_username_string?u.promoter_username_string.includes(t)||(s.custom_attributes.promoter_username_string=`${u.promoter_username_string+t},`):s.custom_attributes.promoter_username_string=`,${t},`}client.users.update(s).catch(t=>{log.info(t)})})})}})},{noAck:!0})};exports.default=(t=>{t.assertQueue("ORDER:CREATE_ORDER",{durable:!0}),t.consume("ORDER:CREATE_ORDER",t=>{const e=JSON.parse(t.content),r=e.customer_id,s=e.email,o=e.project_slug,u=e.project_id,_=e.promoter_id,n=`SELECT t2.id, t2.slug AS category_slug FROM (SELECT category_id FROM public.project_to_category WHERE project_id = '${Number.parseInt(u,10)}') t1, public.category t2 WHERE t1.category_id = t2.id;`,i=`SELECT username, id FROM public.promoter WHERE id = '${_}';`;connPool.query(n,[],(t,e)=>{if(t)log.info(t);else if(e.rows.length>0){const t=e.rows[0].category_slug;r?client.users.find({user_id:r}).then(e=>{const s={user_id:r,custom_attributes:{project_slug_string:"",category_slug_string:"",promoter_username_string:""}},u=e.body.custom_attributes;u.project_slug_string?u.project_slug_string.includes(o)||(s.custom_attributes.project_slug_string=`${u.project_slug_string+o},`):s.custom_attributes.project_slug_string=`,${o},`,u.category_slug_string?u.category_slug_string.includes(t)||(s.custom_attributes.category_slug_string=`${u.category_slug_string+t},`):s.custom_attributes.category_slug_string=`,${t},`,connPool.query(i,[],(t,e)=>{if(t)log.info(t);else if(e.rows.length>0){const t=e.rows[0].username;u.promoter_username_string?u.promoter_username_string.includes(t)||(s.custom_attributes.promoter_username_string=`${u.promoter_username_string+t},`):s.custom_attributes.promoter_username_string=`,${t},`}client.users.update(s).catch(t=>{log.info(t)})})}).catch(t=>{log.info(t)}):client.users.find({email:s}).then(e=>{const s={user_id:r,custom_attributes:{project_slug_string:"",category_slug_string:"",promoter_username_string:""}},u=e.body.custom_attributes;u.project_slug_string?u.project_slug_string.includes(o)||(s.custom_attributes.project_slug_string=`${u.project_slug_string+o},`):s.custom_attributes.project_slug_string=`,${o},`,u.category_slug_string?u.category_slug_string.includes(t)||(s.custom_attributes.category_slug_string=`${u.category_slug_string+t},`):s.custom_attributes.category_slug_string=`,${t},`,connPool.query(i,[],(t,e)=>{if(t)log.info(t);else if(e.rows.length>0){const t=e.rows[0].username;u.promoter_username_string?u.promoter_username_string.includes(t)||(s.custom_attributes.promoter_username_string=`${u.promoter_username_string+t},`):s.custom_attributes.promoter_username_string=`,${t},`}client.users.update(s).catch(t=>{log.info(t)})})})}})},{noAck:!0})});