"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _intercomClient=require("intercom-client"),_config=require("config"),_config2=_interopRequireDefault(_config),_bunyan=require("bunyan"),_bunyan2=_interopRequireDefault(_bunyan),_pg=require("pg"),_pg2=_interopRequireDefault(_pg),_lodash=require("lodash");const log=_bunyan2.default.createLogger({name:"customerRemoveCollection"}),client=new _intercomClient.Client(_config2.default.get("thirdPartyPlatform.intercom")),connPool=new _pg2.default.Pool(_config2.default.get("database.pg")),customerRemoveCollection=e=>{e.assertQueue("CUSTOMER:REMOVE_COLLECTION",{durable:!0}),e.consume("CUSTOMER:REMOVE_COLLECTION",e=>{const t=JSON.parse(e.content),o=t.customer_id,r=t.project_id,c=`SELECT t1.customer_id, array_agg(t2.slug) AS project_collection_string FROM public.favorite t1, public.project t2 WHERE t1.customer_id = ${o} AND t2.id = t1.project_id GROUP BY t1.customer_id;`,i=`SELECT id, slug FROM public.project WHERE id = ${r};`;connPool.query(c,[],(e,t)=>{e?log.info(e):t.rows.length>0&&connPool.query(i,[],(e,r)=>{if(!e){const e=r.rows[0].slug,c={project_collection_string:t.rows[0].project_collection_string},i=t.rows[0].project_collection_string;if(-1!==i.indexOf(e)){const t=_lodash._.difference(i,e),r=t.join(",");0!==t.length?c.project_collection_string=`,${r},`:c.project_collection_string="",client.update({user_id:o,custom_attributes:c}).catch(e=>{log.info(e)})}}})})},{noAck:!0})};exports.default=(e=>{e.assertQueue("CUSTOMER:REMOVE_COLLECTION",{durable:!0}),e.consume("CUSTOMER:REMOVE_COLLECTION",e=>{const t=JSON.parse(e.content),o=t.customer_id,r=t.project_id,c=`SELECT t1.customer_id, array_agg(t2.slug) AS project_collection_string FROM public.favorite t1, public.project t2 WHERE t1.customer_id = ${o} AND t2.id = t1.project_id GROUP BY t1.customer_id;`,i=`SELECT id, slug FROM public.project WHERE id = ${r};`;connPool.query(c,[],(e,t)=>{e?log.info(e):t.rows.length>0&&connPool.query(i,[],(e,r)=>{if(!e){const e=r.rows[0].slug,c={project_collection_string:t.rows[0].project_collection_string},i=t.rows[0].project_collection_string;if(-1!==i.indexOf(e)){const t=_lodash._.difference(i,e),r=t.join(",");0!==t.length?c.project_collection_string=`,${r},`:c.project_collection_string="",client.update({user_id:o,custom_attributes:c}).catch(e=>{log.info(e)})}}})})},{noAck:!0})});