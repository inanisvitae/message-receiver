"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(exports,"__esModule",{value:!0});var _intercomClient=require("intercom-client"),_config=require("config"),_config2=_interopRequireDefault(_config),_bunyan=require("bunyan"),_bunyan2=_interopRequireDefault(_bunyan),_pg=require("pg"),_pg2=_interopRequireDefault(_pg);const log=_bunyan2.default.createLogger({name:"customerAddCollection"}),client=new _intercomClient.Client(_config2.default.get("thirdPartyPlatform.intercom")),connPool=new _pg2.default.Pool(_config2.default.get("database.pg")),customerAddCollection=t=>{t.assertQueue("CUSTOMER:ADD_COLLECTION",{durable:!0}),t.consume("CUSTOMER:ADD_COLLECTION",t=>{const e=JSON.parse(t.content),o=e.customer_id,c=e.project_id,r=`SELECT t1.customer_id, array_agg(t2.slug) AS project_collection_string FROM public.favorite t1, public.project t2 WHERE t1.customer_id = ${o} AND t2.id = t1.project_id GROUP BY t1.customer_id;`,i=`SELECT id, slug FROM public.project WHERE id = ${c};`;connPool.query(r,[],(t,e)=>{t?log.info(t):e.rows.length>0?connPool.query(i,[],(t,c)=>{if(!t){const t=c.rows[0].slug,r={project_collection_string:""},i=e.rows[0].project_collection_string.push(t).join(",");r.project_collection_string=`,${i},`,client.update({user_id:o,custom_attributes:r}).catch(t=>{log.info(t)})}}):0===e.rows.length&&connPool.query(i,[],(t,e)=>{if(!t){const t=e.rows[0].slug,c={project_collection_string:""};c.project_collection_string=`,${t},`,client.update({user_id:o,custom_attributes:c}).catch(t=>{log.info(t)})}})})},{noAck:!0})};exports.default=(t=>{t.assertQueue("CUSTOMER:ADD_COLLECTION",{durable:!0}),t.consume("CUSTOMER:ADD_COLLECTION",t=>{const e=JSON.parse(t.content),o=e.customer_id,c=e.project_id,r=`SELECT t1.customer_id, array_agg(t2.slug) AS project_collection_string FROM public.favorite t1, public.project t2 WHERE t1.customer_id = ${o} AND t2.id = t1.project_id GROUP BY t1.customer_id;`,i=`SELECT id, slug FROM public.project WHERE id = ${c};`;connPool.query(r,[],(t,e)=>{t?log.info(t):e.rows.length>0?connPool.query(i,[],(t,c)=>{if(!t){const t=c.rows[0].slug,r={project_collection_string:""},i=e.rows[0].project_collection_string.push(t).join(",");r.project_collection_string=`,${i},`,client.update({user_id:o,custom_attributes:r}).catch(t=>{log.info(t)})}}):0===e.rows.length&&connPool.query(i,[],(t,e)=>{if(!t){const t=e.rows[0].slug,c={project_collection_string:""};c.project_collection_string=`,${t},`,client.update({user_id:o,custom_attributes:c}).catch(t=>{log.info(t)})}})})},{noAck:!0})});