"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _intercomClient=require("intercom-client"),_config=require("config"),_config2=_interopRequireDefault(_config),_pg=require("pg"),_pg2=_interopRequireDefault(_pg),_bunyan=require("bunyan"),_bunyan2=_interopRequireDefault(_bunyan),_publicConst=require("./publicConst");const log=_bunyan2.default.createLogger({name:"orderCompletePayment"}),client=new _intercomClient.Client(_config2.default.get("thirdPartyPlatform.intercom")),connPool=new _pg2.default.Pool(_config2.default.get("database.pg")),completePayment=e=>{e.assertQueue("ORDER:COMPLETE_PAYMENT",{durable:!0}),e.consume("ORDER:COMPLETE_PAYMENT",e=>{const t=JSON.parse(e.content).customer_id,o=`SELECT customer_id, guest_id, status, promoter_id, payment, id, deleted_at FROM public.order WHERE customer_id = ${t};`;t&&connPool.query(o,[],(e,o)=>{if(e)log.info("Error connecting to pg");else{let e=0;const n=new Map;let r=0;const s={};o.rows.length>0?(o.rows.forEach(t=>{e+=Number.parseInt(t.payment,10);let o=`status_num_${t.status}`;"pending"===t.status&&t.deleted_at&&(o+="_deleted"),-1!==_publicConst.completedOrdersSignature.indexOf(t.status)&&(r+=1),n.has(o)?n.set(o,n.get(o)+1):n.set(o,1)}),[...n].forEach(e=>{s[e[0]]=e[1]}),s.num_orders=r,s.total_payment=e,client.users.update({user_id:t,custom_attributes:s}).catch(e=>{log.info(e)})):log.info("There is no corresponding customer_id or there is no order")}})},{noAck:!0})};exports.default=(e=>{e.assertQueue("ORDER:COMPLETE_PAYMENT",{durable:!0}),e.consume("ORDER:COMPLETE_PAYMENT",e=>{const t=JSON.parse(e.content).customer_id,o=`SELECT customer_id, guest_id, status, promoter_id, payment, id, deleted_at FROM public.order WHERE customer_id = ${t};`;t&&connPool.query(o,[],(e,o)=>{if(e)log.info("Error connecting to pg");else{let e=0;const n=new Map;let r=0;const s={};o.rows.length>0?(o.rows.forEach(t=>{e+=Number.parseInt(t.payment,10);let o=`status_num_${t.status}`;"pending"===t.status&&t.deleted_at&&(o+="_deleted"),-1!==_publicConst.completedOrdersSignature.indexOf(t.status)&&(r+=1),n.has(o)?n.set(o,n.get(o)+1):n.set(o,1)}),[...n].forEach(e=>{s[e[0]]=e[1]}),s.num_orders=r,s.total_payment=e,client.users.update({user_id:t,custom_attributes:s}).catch(e=>{log.info(e)})):log.info("There is no corresponding customer_id or there is no order")}})},{noAck:!0})});