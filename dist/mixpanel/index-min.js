"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _mixpanel=require("mixpanel"),_mixpanel2=_interopRequireDefault(_mixpanel),_config=require("config"),_config2=_interopRequireDefault(_config),_bunyan=require("bunyan"),_bunyan2=_interopRequireDefault(_bunyan);const log=_bunyan2.default.createLogger({name:"mixpanel"}),mixpanel=_mixpanel2.default.init(_config2.default.get("analytics.mixpanel.token")),trackCharge=(e,t,s=null,i=null,a=null)=>{try{mixpanel.people.track_charge(e,t,s,i,a)}catch(e){log.info(e)}},track=(e,t=null,s=null)=>{try{mixpanel.track(e,t,s)}catch(e){log.info(e)}},trackSignedUp=(e,t)=>{try{t.distinct_id&&mixpanel.alias(t.distinct_id,e),mixpanel.track("Account Created",t)}catch(e){log.info(e)}},addListenerMixpanel=e=>{e.then(e=>{e.createChannel().then(e=>{const t="CUSTOMER:USER_REGISTER",s="CUSTOMER:AUTOMATIC_USER_REGISTER",i="ORDER:COMPLETE_PAYMENT";e.assertQueue(t,{durable:!0}),e.consume(t,e=>{const t=JSON.parse(e.content);trackSignedUp(t.customer_id,{distinct_id:t.distinct_id,"Within Checkout Process":!1,"Registration Method":t.reg_method,"First Name":"","Last Name":"",Email:t.email,"Phone Number":t.phone,"Registration Date":t.created_at})},{noAck:!0}),e.assertQueue(s,{durable:!0}),e.consume(s,e=>{const t=JSON.parse(e.content);trackSignedUp(t.customer_id,{distinct_id:t.distinct_id,"Within Checkout Process":!0,"Registration Method":"email - guest","First Name":"","Last Name":"",Email:t.email,"Phone Number":"","Registration Date":t.created_at})},{noAck:!0}),e.assertQueue(i,{durable:!0}),e.consume(i,e=>{const t=JSON.parse(e.content),s={"Order ID":t.order_id,"Order Number":t.order_number,"Event Name":t.event_name,"Delivery Method":t.delivery_method,"Cart Size":t.cart_size,"Cart Value":t.cart_value,"Payment type":t.payment_type,"Total Charge":t.total_charge,"Mis Fees":t.mis_fees,"Delivery Fees":t.delivery_fees,Coupon:t.coupon},i={"Cart Items - Session IDs":[],"Cart Items - Session Names":[],"Cart Items - Session Dates":[],"Cart Items - Session Times":[],"Cart Items - Ticket IDs":[],"Cart Items - Ticket Names":[],"Cart Items - Ticket Prices":[],"Cart Items - Quantities":[]};t.items.forEach(e=>{i["Cart Items - Session IDs"].push(e.show_id),i["Cart Items - Session Names"].push(e.show_label||""),i["Cart Items - Session Dates"].push(e.show_date),i["Cart Items - Session Times"].push(e.show_time||""),i["Cart Items - Ticket IDs"].push(e.pricing_id),i["Cart Items - Ticket Names"].push(e.pricing_label||""),i["Cart Items - Ticket Prices"].push(e.price/100),i["Cart Items - Quantities"].push(e.quantity)}),t.distinct_id?(trackCharge(t.distinct_id,t.total_charge),track("Complete Purchase",Object.assign({distinct_id:t.distinct_id},s,i))):track("Complete Purchase",Object.assign({},s,i))},{noAck:!0})}).catch(e=>{log.info(e)})}).catch(e=>{log.info(e)})};exports.default=(e=>{e.then(e=>{e.createChannel().then(e=>{const t="CUSTOMER:USER_REGISTER",s="CUSTOMER:AUTOMATIC_USER_REGISTER",i="ORDER:COMPLETE_PAYMENT";e.assertQueue(t,{durable:!0}),e.consume(t,e=>{const t=JSON.parse(e.content);trackSignedUp(t.customer_id,{distinct_id:t.distinct_id,"Within Checkout Process":!1,"Registration Method":t.reg_method,"First Name":"","Last Name":"",Email:t.email,"Phone Number":t.phone,"Registration Date":t.created_at})},{noAck:!0}),e.assertQueue(s,{durable:!0}),e.consume(s,e=>{const t=JSON.parse(e.content);trackSignedUp(t.customer_id,{distinct_id:t.distinct_id,"Within Checkout Process":!0,"Registration Method":"email - guest","First Name":"","Last Name":"",Email:t.email,"Phone Number":"","Registration Date":t.created_at})},{noAck:!0}),e.assertQueue(i,{durable:!0}),e.consume(i,e=>{const t=JSON.parse(e.content),s={"Order ID":t.order_id,"Order Number":t.order_number,"Event Name":t.event_name,"Delivery Method":t.delivery_method,"Cart Size":t.cart_size,"Cart Value":t.cart_value,"Payment type":t.payment_type,"Total Charge":t.total_charge,"Mis Fees":t.mis_fees,"Delivery Fees":t.delivery_fees,Coupon:t.coupon},i={"Cart Items - Session IDs":[],"Cart Items - Session Names":[],"Cart Items - Session Dates":[],"Cart Items - Session Times":[],"Cart Items - Ticket IDs":[],"Cart Items - Ticket Names":[],"Cart Items - Ticket Prices":[],"Cart Items - Quantities":[]};t.items.forEach(e=>{i["Cart Items - Session IDs"].push(e.show_id),i["Cart Items - Session Names"].push(e.show_label||""),i["Cart Items - Session Dates"].push(e.show_date),i["Cart Items - Session Times"].push(e.show_time||""),i["Cart Items - Ticket IDs"].push(e.pricing_id),i["Cart Items - Ticket Names"].push(e.pricing_label||""),i["Cart Items - Ticket Prices"].push(e.price/100),i["Cart Items - Quantities"].push(e.quantity)}),t.distinct_id?(trackCharge(t.distinct_id,t.total_charge),track("Complete Purchase",Object.assign({distinct_id:t.distinct_id},s,i))):track("Complete Purchase",Object.assign({},s,i))},{noAck:!0})}).catch(e=>{log.info(e)})}).catch(e=>{log.info(e)})});